<!doctype html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Переводчик мансийского языка</title>
	<link rel="icon" href="{{ url_for('static', path='images/Favicon.png') }}" type="image/png">
	<link rel="apple-touch-icon" href="{{ url_for('static', path='images/Favicon.png') }}" type="image/png">
	<link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
	<script src="{{ url_for('static', path='js/keyboard.js') }}"></script>
    <script>
        // Функция для отправки текста на сервер и получения перевода
		const apiToken = "{{ api_token }}";

        async function translateText() {
            const inputText = document.getElementById("inputText").value;
            const sourceLang = document.getElementById("source_lang").textContent;
            const targetLang = document.getElementById("target_lang").textContent;

			const keyboardSection = document.getElementById("keyboardSection");
			keyboardSection.classList.remove("visible");

            // Отправляем запрос на перевод
            const response = await fetch("/translate", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
					"Authorization": `Bearer ${apiToken}`
                },
                body: JSON.stringify({
                    text: inputText,
                    source_lang: sourceLang,
                    target_lang: targetLang
                })
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById("translatedText").textContent = data.translated_text;

				console.log(sourceLang, targetLang);

				if (sourceLang == 'РУССКИЙ'){
					language = 'russian'
				} else {
					language = 'mansi'
				}

				console.log(language)
                searchInDictionary(inputText, language);
            } else {
                console.error("Ошибка перевода");
            }
        }

        // Функция для поиска слова и фразы в словаре
        async function searchInDictionary(query, language) {
            const sourceLang = document.getElementById("source_lang").value;
			const targetLang = document.getElementById("target_lang").value;

            // Поиск слова
            const wordResponse = await fetch(`/search/word?query=${query}&language=${language}&limit=10`,{
            method: "GET",
            headers: {
                "Authorization": `Bearer ${apiToken}`, // Добавляем заголовок Authorization
                "Content-Type": "application/json"
				}
            });

            if (wordResponse.ok) {
                const words = await wordResponse.json();
				console.log("Слова с API:", words);
                displayWords(words, language);
            }

            // Поиск фразы
            const phraseResponse = await fetch(`/search/phrase?query=${query}&language=${language}&limit=5`,{
            method: "GET",
            headers: {
                "Authorization": `Bearer ${apiToken}`, // Добавляем заголовок Authorization
                "Content-Type": "application/json"
				}
			});
            if (phraseResponse.ok) {
                const phrases = await phraseResponse.json();
				console.log("Фразы с API:", phrases);
                displayPhrases(phrases, language);
            }
        }

		// Функция для отображения найденных слов
		function displayWords(words, language) {
			const wordContainer = document.getElementById("wordDictionary");
			wordContainer.innerHTML = "";  // Очищаем контейнер перед добавлением новых слов

			words.forEach(word => {
				const wordElement = document.createElement("li");
				if (language == 'russian'){
					wordElement.innerHTML = `<strong>${word.russian_word}</strong>: ${word.mansi_word}`; 
				} else {
					wordElement.innerHTML = `<strong>${word.mansi_word}</strong>: ${word.russian_word}`; 
				}
				wordContainer.appendChild(wordElement);
			});
		}

		// Функция для отображения найденных фраз
		function displayPhrases(phrases, language) {
			const phraseContainer = document.getElementById("phraseDictionary");
			phraseContainer.innerHTML = "";  // Очищаем контейнер перед добавлением новых фраз

			phrases.forEach(phrase => {
				const phraseElement = document.createElement("li");
				if (language == 'russian') {
					phraseElement.innerHTML = `<strong>${phrase.russian_phrase}</strong>: ${phrase.mansi_phrase}`; 
				} else {
					phraseElement.innerHTML = `<strong>${phrase.mansi_phrase}</strong>: ${phrase.russian_phrase}`; 
				}
				phraseContainer.appendChild(phraseElement);
			});
		}


		function clearText() {
            document.getElementById("inputText").value = "";
            document.getElementById("translatedText").textContent = "";
			document.getElementById("wordDictionary").textContent = "";
            document.getElementById("phraseDictionary").textContent = "";
        }

        // Функция для смены языков
        function switchLanguages() {
			event.preventDefault()
            let sourceLang = document.getElementById("source_lang").textContent;
            let targetLang = document.getElementById("target_lang").textContent;
            document.getElementById("source_lang").textContent = targetLang;
            document.getElementById("target_lang").textContent = sourceLang;

			const keyboardElement = document.querySelector('.keyboard');
			if (keyboardElement){
				if (keyboardElement.id.includes('russian')){
					const source_keyboard = keyboardElement.id.replace('russian', 'mansi');
					loadKeyboardFromFile('/keyboard/' + source_keyboard.replace('keyboard-', ''))
				} else {
					const source_keyboard = keyboardElement.id.replace('mansi', 'russian');
					loadKeyboardFromFile('/keyboard/' + source_keyboard.replace('keyboard-', ''))
				}
			}
        }

        // Обработка нажатия Enter для отправки текста
        function handleEnterKey(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                translateText();
            }
        }

		const handleCopyInputText = () => {
			event.preventDefault()
			const inputText = document.getElementById("inputText").value
			navigator.clipboard.writeText(inputText)
		};

		const handleCopyTranslatedText = () => {
			event.preventDefault()
			const inputText = document.getElementById("translatedText").value
			navigator.clipboard.writeText(inputText)
		};

		const speakText = (text) => {
			event.preventDefault()
            const textToSpeak = document.getElementById(text).value

            if (!textToSpeak) {
                alert("Нет текста для озвучивания!");
                return;
            }

            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'ru-RU'; // Установите нужный язык, например, 'ru-RU' для русского

            // Озвучиваем текст
            window.speechSynthesis.speak(utterance);
        };
		
		function setupVoiceRecognition(inputFieldId, micIconId, language = 'ru-RU') {
			let recognition;
			let isListening = false;

			// Проверка поддержки API в браузере
			if ('webkitSpeechRecognition' in window) {
				recognition = new webkitSpeechRecognition();
				recognition.lang = language; // Установите язык распознавания
				recognition.interimResults = false; // Вернуть только окончательные результаты
				recognition.maxAlternatives = 1;

				// Обработка результата распознавания
				recognition.onresult = (event) => {
					const result = event.results[0][0].transcript;
					document.getElementById(inputFieldId).value = result; // Вставка текста в поле
					console.log('Распознанный текст:', result);
				};

				recognition.onerror = (event) => {
					console.error('Ошибка распознавания речи:', event.error);
					recognitionError = true;
				};

				recognition.onend = () => {
					isListening = false;
					console.log('Распознавание завершено');
					document.getElementById(micIconId).style.backgroundColor = ''; // Сброс цвета кнопки микрофона

					            // Проверяем флаг ошибки перед переводом
					if (!recognitionError) {
               			translateText();
            		} else {
                		console.log('Перевод отменен из-за ошибки распознавания');
            		}
				};
			} else {
				console.log('Ваш браузер не поддерживает SpeechRecognition API');
				return;
			}

			// Функция для начала и остановки распознавания речи
			function toggleVoiceRecognition() {
				if (isListening) {
					recognition.stop();
					isListening = false;
					document.getElementById(micIconId).style.backgroundColor = ''; // Сброс цвета кнопки микрофона
				} else {
					recognition.start();
					isListening = true;
					document.getElementById(micIconId).style.backgroundColor = 'lightgreen'; // Активация микрофона
					recognitionError = false;
				}
			}

			// Возвращаем функцию для переключения распознавания речи
			return toggleVoiceRecognition;
		}

		// Инициализация голосового ввода при загрузке страницы
		window.onload = function() {
			const toggleVoiceRecognition = setupVoiceRecognition('inputText', 'micIcon');
			document.getElementById('micIcon').addEventListener('click', function(event) {
				event.preventDefault(); // Предотвращение перезагрузки страницы
				toggleVoiceRecognition(); // Вызов функции голосового ввода
			});
		};
		
    </script>
</head>
<body>
	<section class="header__wrap">
		<header class="header">
			<a class="logotype" href="/">
				<div class="logotype_img" href="/">
					<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_37_408)">
						<path fill-rule="evenodd" clip-rule="evenodd" d="M16.7719 35.313C15.0679 35.313 13.6753 35.3404 13.6753 35.3743C13.6753 35.7576 13.9515 37.3768 14.0753 37.7015C14.3449 38.4225 15.0549 39.2321 15.7206 39.5776L15.929 39.6871L17.7489 37.6715C18.752 36.5646 19.6366 35.5803 19.7186 35.4851L19.8685 35.3143H16.7719V35.313Z" fill="white"/>
						<path fill-rule="evenodd" clip-rule="evenodd" d="M11.3513 16.8909C11.3382 17.106 11.0946 17.3081 10.9487 17.5089C10.6687 17.8948 10.3755 18.2742 10.102 18.664C9.98603 18.8348 9.92089 18.8139 9.81146 18.6601C9.42586 18.1203 9.03634 17.5845 8.6338 17.0538C8.52438 16.9143 8.54522 16.8283 8.64423 16.6979C8.97251 16.2742 9.28256 15.844 9.60042 15.4137C9.73069 15.239 9.87008 15.0682 9.94825 14.8257C10.2348 15.372 10.6244 15.7892 10.9422 16.2572C11.0855 16.4685 11.3695 16.6575 11.3513 16.8896V16.8909Z" fill="white"/>
						<path fill-rule="evenodd" clip-rule="evenodd" d="M19.0191 2.73988C18.7116 1.45568 17.8545 0.522185 16.6364 0.142791C16.1857 -0.000622239 15.8313 -0.007141 9.51184 0.00328907C4.35698 0.00720035 2.79371 0.0306682 2.5475 0.108894C1.36333 0.484376 0.485294 1.37354 0.123138 2.56517C-0.0410051 3.10102 -0.0410051 29.8607 0.123138 30.3965C0.491807 31.609 1.37245 32.4903 2.58137 32.8567C2.8823 32.9493 4.54066 32.9662 12.4781 32.9688H22.0127L22.2889 32.6611C22.4426 32.4903 22.5898 32.2335 22.6172 32.0901C22.6758 31.7889 19.2106 3.53387 19.0191 2.73858V2.73988ZM18.8067 14.7175C18.4993 15.1543 18.1723 15.5754 17.8505 16.0017C16.5153 17.7813 15.1774 19.5623 13.8525 21.3484C13.6988 21.5531 13.5425 21.6248 13.2897 21.6222C11.0399 21.6118 8.79013 21.6157 6.54033 21.6222C6.34883 21.6222 6.23029 21.5635 6.11695 21.411C4.47813 19.2207 2.83931 17.0343 1.19397 14.8479C1.01941 14.6158 0.917797 14.3668 0.985538 14.0787C1.0611 13.7579 1.25911 13.5454 1.57567 13.4633C1.9274 13.3746 2.21791 13.4946 2.43286 13.7775C2.83279 14.2964 3.22491 14.8231 3.61443 15.3485C4.72434 16.8244 5.83035 18.2976 6.93636 19.78C7.04188 19.9234 7.15131 19.9886 7.3363 19.9821C7.79095 19.9691 8.24038 19.9782 8.75626 19.9782C8.28468 19.3328 7.85217 18.7383 7.41446 18.1464C6.69015 17.1621 5.96714 16.179 5.24673 15.1908C4.9432 14.7775 5.00443 14.2925 5.37961 14.0083C5.75219 13.7319 6.23289 13.8036 6.53643 14.1999C6.81 14.5519 7.06924 14.917 7.33239 15.2755C7.49914 15.505 7.49914 15.5011 7.66328 15.282C7.90559 14.9574 8.14398 14.6328 8.38759 14.3042C8.88914 13.6315 9.56525 13.6888 9.94043 14.4437C10.029 14.4372 10.0186 14.3512 10.046 14.3042C10.3365 13.754 11.0256 13.6758 11.4177 14.1608C11.7043 14.5233 11.9714 14.8987 12.2436 15.2716C12.36 15.4246 12.476 15.4211 12.5915 15.2612C12.8403 14.9235 13.0865 14.5806 13.3392 14.2429C13.6636 13.8127 14.1417 13.7201 14.5273 14.0004C14.9233 14.2912 14.9715 14.7788 14.6472 15.2208C13.5451 16.724 12.4456 18.2233 11.3422 19.7239C11.294 19.7891 11.2497 19.8543 11.2054 19.9182C11.2458 20.0043 11.3213 19.9769 11.3799 19.9769C11.7695 19.9769 12.159 19.9638 12.5446 19.9808C12.7595 19.9938 12.882 19.9091 13.0057 19.7448C14.4635 17.7944 15.9251 15.8466 17.3855 13.8961C17.4259 13.8453 17.4636 13.7905 17.5053 13.7423C17.8023 13.3968 18.2661 13.3355 18.6152 13.5924C18.9709 13.8518 19.066 14.3407 18.8067 14.7162V14.7175Z" fill="white"/>
						<path fill-rule="evenodd" clip-rule="evenodd" d="M32.0971 18.1386C32.1414 18.3367 32.9947 22.5909 32.9947 22.6274C32.9947 22.6405 32.4488 22.6509 31.7831 22.6509C31.1174 22.6509 30.5742 22.6405 30.5742 22.6274C30.5742 22.5896 31.4249 18.3367 31.4718 18.1386C31.5056 17.9991 31.5669 17.9639 31.7818 17.9639C31.9968 17.9639 32.0619 17.9978 32.0958 18.1386H32.0971Z" fill="white"/>
						<path fill-rule="evenodd" clip-rule="evenodd" d="M39.8769 9.7541C39.5017 8.52075 38.6341 7.61203 37.4838 7.25349C37.0292 7.11399 36.6475 7.10617 29.4539 7.10617H21.8994L21.9268 7.31738C21.9437 7.43732 22.6263 12.8962 23.4431 19.4502C25.0507 32.3313 25.0376 32.1566 24.6859 33.0549C24.454 33.6494 24.2495 33.9088 21.4421 37.1135C20.0899 38.6584 18.9839 39.9361 18.9839 39.9596C18.9839 39.9831 23.0497 40 28.0235 40C35.5311 40 37.1217 39.9791 37.4187 39.8905C38.6276 39.5215 39.5083 38.6402 39.8769 37.4303C40.0411 36.8944 40.0411 10.2886 39.8769 9.7528V9.7541ZM35.5832 29.6208C35.1428 29.686 34.8589 29.5973 34.5592 29.2961C34.2752 29.0093 34.2687 28.995 33.904 27.1397C33.6994 26.1111 33.5144 25.2063 33.4949 25.1306C33.4571 25.0081 33.3073 24.9937 31.7844 24.9937C30.2616 24.9937 30.1156 25.0068 30.0779 25.1306C30.057 25.2063 29.8733 26.1045 29.6714 27.1254C29.334 28.8372 29.2858 29.0015 29.0604 29.257C28.7973 29.5608 28.4325 29.6847 28.0026 29.6221C27.6574 29.5712 27.1728 29.0862 27.122 28.7342C27.0738 28.42 29.4096 16.6093 29.5907 16.2638C29.7379 15.973 29.8773 15.8609 30.2433 15.724C30.4622 15.6458 30.896 15.621 31.9056 15.6354C33.4246 15.6588 33.6669 15.7279 33.9535 16.2168C34.145 16.548 36.5068 28.3731 36.4521 28.7355C36.4013 29.0771 35.9167 29.5725 35.5845 29.6208H35.5832Z" fill="white"/></g><defs><clipPath id="clip0_37_408"><rect width="40" height="40" fill="white"/></clipPath></defs>
					</svg>
				</div>
				<div class="logotype_text">
				Переводчик <br>
				мансийского <br>
				языка
				</div>
			</a>
			<nav>
				<ul class="menu">
					<li><a href="/add_translation?type=word">Добавить слово</a></li>
					<li><a href="">Полезные материалы</a></li>
					<li><a href="">Словарь</a></li>
					<li><a href="">Тематический корпус</a></li>
				</ul>
			</nav>
		</header>
		<div class="tittle_background__warp">
			<div class="big_patterns_bg">
				<img src="{{ url_for('static', path='images/big_pattern_bg.svg') }}">
				<img src="{{ url_for('static', path='images/big_pattern_bg.svg') }}">
			</div>
			<div class="pattern_line_bg">
				<img src="{{ url_for('static', path='images/pattern_line_bg.svg') }}">
			</div>
		</div>
	</section>
	<section class="content_index__wrap">
		<section class="translation_wrap">
			<div class="container">

				<div class="forms">

					<div class="form_trasnlation" margin="24px">
						<div class="form_translation_header">
							<p id="source_lang">РУССКИЙ</p>
						</div>
						<div class="form_translation_body">
							<textarea id="inputText" placeholder="Начните писать здесь..." oninput="updateCharacterCount()" onkeydown="handleEnterKey(event)"></textarea>
							<div>
								<a id="clear_icon" class="icon_button" onclick="clearText()">
									<svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_6_560)">
									<path fill-rule="evenodd" clip-rule="evenodd" d="M59.1722 64L0 4.82782L4.82781 1.50135e-06L64 59.1722L59.1722 64Z" fill="#0E0909"/>
									<path fill-rule="evenodd" clip-rule="evenodd" d="M64 4.82781L4.82782 64L1.18773e-06 59.1722L59.1722 0L64 4.82781Z" fill="#0E0909"/></g><defs><clipPath id="clip0_6_560"><rect width="64" height="64" fill="white"/></clipPath></defs>
									</svg>
								</a>
							</div>
						</div>
						<div class="form_translation_footer">
							<ul class="form_footer_menu">
								<a class="icon_button" onclick="speakText('inputText')"><img src="{{ url_for('static', path='images/icons/volume.svg') }}"></a>
								<a id="micIcon" class="icon_button"><img src="{{ url_for('static', path='images/icons/microphone.svg') }}"></a>
								<a class="icon_button" onclick="handleCopyInputText()"><img src="{{ url_for('static', path='images/icons/copy.svg') }}"></a>
							</ul>
							<ul class="form_footer_menu">
								<div class="number_of_characters">
									<p id="charCount">0 / 5000</p>
								</div>
								<a id="keyboard_icon" class="icon_button" onclick="toggleKeyboard()"><img src="{{ url_for('static', path='images/icons/keyboard.svg') }}"></a>
							</ul>
						</div>
					</div>

					<div class="change_translation__wrap">
						<a class="change_translation" onclick="switchLanguages()">
							<svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
								<g clip-path="url(#clip0_1_47)"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.45403 25.6742L16.9079 34.1747L19.9522 31.1167L22.9965 28.0588L19.6585 24.6986L16.3205 21.3385L29.9729 21.3385L43.6254 21.3385L43.6254 17.0873L43.6254 12.8362L29.9729 12.8362L16.3205 12.8362L19.6585 9.47603L22.9965 6.11591L19.9522 3.05796L16.9079 -7.39067e-07L8.45403 8.50047C3.8042 13.1757 -2.00898e-06 17.0399 -2.00691e-06 17.0873C-2.00483e-06 17.1348 3.8042 20.9989 8.45403 25.6742ZM33.9434 50.2465L47.5958 50.2465L44.2174 53.6472L40.8388 57.0482L43.7943 60.024C45.42 61.6609 46.8271 63 46.9215 63C47.0159 63 50.8972 59.1738 55.5465 54.4975L64 45.9948L55.5044 37.4513L47.0087 28.9076L43.9643 31.9658L40.9198 35.0239L44.2578 38.384L47.5958 41.7441L33.9434 41.7441L20.2909 41.7441L20.2909 45.9953L20.2909 50.2465L33.9434 50.2465Z" fill="#0E0909"/></g><defs><clipPath id="clip0_1_47"><rect width="64" height="64" fill="white"/></clipPath></defs>
							</svg>
						</a>
					</div>

					<div class="form_trasnlation">
						<div class="form_translation_header">
							<p id="target_lang">МАНСИЙСКИЙ</p>
						</div>
						<div class="form_translation_body">
							<textarea id="translatedText" placeholder="Ваш перевод будет здесь..." class="translation_result2"></textarea>
							<div>
								<a class="icon_button" onclick="handleCopyTranslatedText()">
									<svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
									<path fill-rule="evenodd" clip-rule="evenodd" d="M19.7559 3V6H34.5118H49.2678V31.2681V56.5364L54.6 56.5015L59.9323 56.4667L59.9661 28.2333L60 0H39.8779H19.7559V3ZM23.7803 19.4667V29.0667H14.3901H5V46.5333V64H13.6973C18.4807 64 27.5657 63.9601 33.886 63.9113L45.3776 63.8228V36.8447V9.86667H34.5789H23.7803V19.4667ZM12.4295 17.4759C8.45396 21.5876 5.1811 25.0076 5.15655 25.0759C5.12932 25.1515 7.97224 25.2 12.4339 25.2H19.7559V17.6C19.7559 13.42 19.7338 10 19.7068 10C19.6799 10 16.405 13.3641 12.4295 17.4759Z" fill="#0E0909"/>
									</svg>
								</a>
							</div>
						</div>
						<div class="form_translation_footer">
							<ul class="form_footer_menu">
								<a class="icon_button" onclick="speakText('translatedText')"><img src="{{ url_for('static', path='images/icons/volume.svg') }}"></a>
							</ul>
							<ul class="form_footer_menu">
								<a class="icon_button"><img src="{{ url_for('static', path='images/icons/warning.svg') }}"></a>
								<a class="icon_button"><img src="{{ url_for('static', path='images/icons/rate.svg') }}"></a>
							</ul>
						</div>
					</div>

				</div>
			</div>
			
		</section>
		<section class="additinionals__wrap">
			<div class="container">
				<section class="examples_translation__wrap">
					<h1>Примеры использования</h1>
					<ul id="phraseDictionary">
						<!-- Фразы будут добавляться сюда динамически -->
					</ul>
				</section>
				<section class="examples_translation__wrap">
					<h1>Словарь</h1>
					<ul id="wordDictionary">
						<!-- Слова будут добавляться сюда динамически -->
					</ul>
				</section>
			</div>
		</section>
	</section>
	<section class="keyboard__wrap" id="keyboardSection">
	</section>
</body>
</html>